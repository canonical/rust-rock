# spellchecker: ignore rustc rockcraft coreutils binutils archiver

name: rust
version: '1.75'
summary: Chiseled rust 1.75 rock
description: |
    Rust is a modern memory-safe systems programming language focused on
    performance and reliability.

    This image is a chiselled Ubuntu rock based on Ubuntu 24.04. It contains
    a minimal Rust 1.75 toolchain and Cargo build system which can be used to
    build a wide variety of Rust applications. It also includes a minimal
    GCC toolchain to custom build steps in Cargo builds.
    
    Any additional dependencies can be either mounted at runtime or installed
    with the apt installation included in this rock.

# rust and cargo are dual licensed under MIT or Apache-2.0
# https://www.rust-lang.org/policies/licenses
# the GCC toolchain included in this rock is licensed under GPL-3.0
# https://gcc.gnu.org/onlinedocs/libstdc++/manual/license.html

# commended out since rockcraft does not support license expressions
# https://github.com/canonical/rockcraft/issues/978
# license: (MIT OR Apache-2.0) AND GPL-3.0

base: bare
build-base: ubuntu@24.04

platforms:
  amd64:
  arm64:

# https://doc.rust-lang.org/cargo/reference/environment-variables.html
environment:
  CARGO_HOME: /cargo

parts:
  rust:
    plugin: nil
    source: https://github.com/canonical/chisel-releases.git
    source-type: git
    source-branch: ubuntu-24.04
    override-build: bash /root/project/rust_override_build.sh
    # TODO: we have to pass the --arch flag to chisel to install the correct
    #       slices, so we cannot use the rockcraft stage-packages feature.
    #       see: https://github.com/canonical/chisel/pull/256
    #       once that's all fixed we should switch to the following:
    #
    # stage-packages:
    #   - cargo_cargo  # includes rustc
    #   # ar is needed to create static libraries, which cargo sometimes does
    #   # when building dependencies
    #   - binutils_archiver
    #   # cargo needs ca-certificates to be able to download crates.io index
    #   # + its required in SDK rocks
    #   - ca-certificates_data
    #   # this is an SDK rock. we really want coreutils
    #   - coreutils_bins
    #   # we want the base-files_chisel to generate the chisel manifest, and
    #   # base-files_release-info  to indicate that this is a 24.04 rock
    #   - base-files_chisel
    #   - base-files_release-info
    #   # package management, to be able to install additional dependencies if needed 
    #   - apt_apt-get
    # override-build: |
    #   # we need to create a symlink for rustc to find the linker
    #   ln -s gcc-13 "$CRAFT_PART_INSTALL"/usr/bin/cc

  deb-security-manifest:
    plugin: nil
    after: [rust]
    source: https://github.com/lczyk/rocks-security-manifest
    source-type: git
    source-branch: un-make
    override-build: ./install_gen_manifest
    override-prime: gen_manifest
